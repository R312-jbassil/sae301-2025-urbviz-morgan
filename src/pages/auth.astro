---
import Layout from "../layouts/Layout.astro";
import { createServerPocketBase } from "../lib/pocketbase.server";

const pb = createServerPocketBase(Astro.request.headers.get("cookie") ?? "");
let currentUser: Record<string, unknown> | null = null;

if (pb.authStore.isValid) {
  currentUser = structuredClone(pb.authStore.model ?? null);
}
---
<Layout title="Mon espace TaVue" description="Connectez-vous pour retrouver vos creations, commandes et suivis atelier.">
  <section class="account-page auth-page">
    <div class="mx-auto flex max-w-4xl flex-col gap-8">
      <header class="account-header">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <h1 class="text-3xl font-semibold">Espace client TaVue</h1>
            <p class="text-[rgba(15,23,42,0.7)]">
              Accedez a vos configurations sauvegardees, suivez vos commandes et retrouvez vos informations personnelles.
            </p>
          </div>
        </div>
      </header>

      {currentUser ? (
        <div class="card space-y-6 p-8">
          <div class="space-y-2">
            <span class="badge badge-primary w-fit">Session active</span>
            <h2 class="text-2xl font-semibold">Bonjour {(currentUser.name as string) || (currentUser.email as string)}</h2>
            <p class="text-sm text-[rgba(15,23,42,0.75)]">
              Vous etes connecte(e) avec l'adresse {(currentUser.email as string) || "n/a"}.
            </p>
          </div>
          <div class="flex flex-col gap-3 md:flex-row">
            <a class="btn btn-primary flex-1" href="/configurateur">Acceder au configurateur</a>
            <button type="button" class="btn btn-outline flex-1" data-logout>
              Se deconnecter
            </button>
          </div>
          <div class="auth-feedback" data-feedback hidden></div>
        </div>
      ) : (
        <div class="card space-y-6 p-8">
          <div class="space-y-2">
            <span class="badge badge-primary w-fit">Connexion</span>
            <h2 class="text-2xl font-semibold">Identifiez-vous</h2>
            <p class="text-sm text-[rgba(15,23,42,0.75)]">
              Utilisez vos identifiants PocketBase fournis par l'atelier TaVue pour acceder a vos donnees.
            </p>
          </div>
          <form id="login-form" class="space-y-5">
            <div class="space-y-2">
              <label class="text-sm font-medium text-[rgba(15,23,42,0.75)]" for="login-email">Adresse email</label>
              <input
                id="login-email"
                name="email"
                class="form-input"
                type="email"
                placeholder="prenom@tavue.fr"
                autocomplete="email"
                required
              />
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-[rgba(15,23,42,0.75)]" for="login-password">Mot de passe</label>
              <input
                id="login-password"
                name="password"
                class="form-input"
                type="password"
                placeholder="••••••••"
                autocomplete="current-password"
                required
              />
            </div>
            <button type="submit" class="btn btn-primary w-full">Se connecter</button>
          </form>
          <div class="auth-feedback" data-feedback hidden></div>
          <p class="text-xs text-[rgba(15,23,42,0.6)]">
            Vous n'avez pas encore de compte ? Contactez l'equipe atelier pour obtenir vos identifiants.
          </p>
        </div>
      )}
    </div>
  </section>

  <script is:inline>
    const loginForm = document.querySelector<HTMLFormElement>("#login-form");
    const feedbackNodes = Array.from(document.querySelectorAll<HTMLElement>(".auth-feedback"));
    const logoutButton = document.querySelector<HTMLButtonElement>("[data-logout]");

    const showFeedback = (message, state = "success") => {
      feedbackNodes.forEach((node) => {
        node.dataset.state = state;
        node.textContent = message;
        node.hidden = false;
      });
    };

    const clearFeedback = () => {
      feedbackNodes.forEach((node) => {
        node.hidden = true;
        node.textContent = "";
        node.dataset.state = "";
      });
    };

    loginForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      clearFeedback();
      const formData = new FormData(loginForm);
      const payload = {
        email: String(formData.get("email") || "").trim(),
        password: String(formData.get("password") || ""),
      };

      loginForm.querySelectorAll("button, input").forEach((el) => (el.disabled = true));

      try {
        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (!response.ok || !data?.ok) {
          throw new Error(data?.message || "Connexion impossible. Verifiez vos identifiants.");
        }

        showFeedback("Connexion reussie, redirection en cours...");
        window.setTimeout(() => window.location.reload(), 600);
      } catch (error) {
        console.error(error);
        const message = error instanceof Error ? error.message : "Erreur inconnue lors de la connexion.";
        showFeedback(message, "error");
      } finally {
        loginForm.querySelectorAll("button, input").forEach((el) => (el.disabled = false));
      }
    });

    logoutButton?.addEventListener("click", async () => {
      clearFeedback();
      logoutButton.disabled = true;
      try {
        const response = await fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error("La deconnexion a echoue. Reessayez.");
        }
        showFeedback("Vous etes maintenant deconnecte(e).", "success");
        window.setTimeout(() => window.location.reload(), 600);
      } catch (error) {
        console.error(error);
        const message = error instanceof Error ? error.message : "Erreur lors de la deconnexion.";
        showFeedback(message, "error");
        logoutButton.disabled = false;
      }
    });
  </script>
</Layout>
